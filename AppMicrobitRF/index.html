<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reconocimiento Facial Profe Vale</title>
  <meta name="description" content="Reconocimiento facial con TensorFlow para micro:bit - Profe Vale">
  <meta name="theme-color" content="#39ff14">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, #232946 0%, #3f2c6e 100%);
      color: #e0e0e0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    @media (min-width: 900px) {
      .container {
        flex-direction: row;
        gap: 2rem;
        align-items: flex-start;
        justify-content: center;
      }
    }
    .camera-panel {
      flex: 2 1 480px;
      min-width: 320px;
      max-width: 640px;
    }
    .data-panel {
      flex: 1 1 320px;
      min-width: 280px;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card-glass {
      background: rgba(44, 62, 80, 0.6);
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(39,255,20,0.10);
      border: 1.2px solid rgba(39,255,20,0.18);
      backdrop-filter: blur(6px);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .param-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    @media (min-width: 600px) {
      .param-grid { grid-template-columns: repeat(4, 1fr); }
    }
    @media (min-width: 900px) {
      .param-grid { grid-template-columns: repeat(6, 1fr); }
    }
    .param-card {
      background: rgba(44,62,80,0.7);
      border-radius: 8px;
      box-shadow: 0 1px 4px #00d2ff44;
      border: 1px solid #00d2ff88;
      padding: 0.4rem 0.2rem;
      text-align: center;
      min-width: 0;
    }
    .param-label {
      font-weight: 600;
      color: #39ff14;
      font-size: 0.85rem;
      margin-bottom: 0.1rem;
      letter-spacing: 0.5px;
    }
    .param-value {
      font-family: 'Roboto Mono', 'Courier New', monospace;
      font-weight: bold;
      color: #e0e0e0;
      font-size: 0.95rem;
      background: none;
      border: none;
      padding: 0.1rem 0;
      margin-top: 0.05rem;
    }
    .btn-neon {
      background: transparent;
      color: #39ff14;
      border: 2px solid #39ff14;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 0.75rem 2rem;
      box-shadow: 0 0 8px #39ff14, 0 0 24px #00d2ff;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
    }
    @media (max-width: 600px) {
      .btn-neon {
        font-size: 0.85rem;
        padding: 0.5rem 0.7rem;
      }
      .param-grid {
        font-size: 0.85rem;
      }
      .card-glass {
        padding: 0.5rem;
      }
    }
    .btn-neon:hover, .btn-neon:focus {
      background: rgba(39,255,20,0.12);
      box-shadow: 0 0 24px #39ff14, 0 0 48px #00d2ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="camera-panel">
      <div class="card-glass" style="padding:0.5rem 0.5rem 1.5rem 0.5rem; display:flex; flex-direction:column; align-items:center;">
        <div style="position:relative; width:100%; max-width:480px; margin:0 auto;">
          <video id="video" width="480" height="360" autoplay playsinline style="width:100%; max-width:480px; border-radius:16px; box-shadow:0 0 24px #00d2ff;"></video>
          <canvas id="canvas" width="480" height="360" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
        </div>
        <div style="display:flex;gap:0.5rem;margin-top:1rem;width:100%;max-width:480px;">
          <button id="startBtn" class="btn-neon" style="flex:1;" disabled>‚ñ∂Ô∏è Iniciar Detecci√≥n</button>
          <button id="stopBtn" class="btn-neon" style="flex:1;" disabled>‚èπÔ∏è Detener</button>
          <button id="toggleCameraBtn" class="btn-neon" style="flex:1;">üîÑ Cambiar c√°mara</button>
        </div>
      </div>
    </div>
    <div class="data-panel">
      <div class="card-glass">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
          <span id="statusBadge" style="font-weight:bold;">Desconectado</span>
          <button id="connectBtn" class="btn-neon" style="min-width:140px;">üîó Conectar al Micro:bit</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:0.5rem;font-size:0.98rem;">
          <div>Enviados: <span id="sendCount">0</span></div>
        </div>
        <div id="feedback" style="margin-bottom:0.5rem;display:flex;flex-wrap:wrap;gap:0.5rem;max-height:40px;overflow-y:auto;"></div>
      </div>
      <div class="card-glass">
        <div class="param-grid">
          <div class="param-card"><span class="param-label">Ubicaci√≥n X</span><div class="param-value" id="xValue">0</div></div>
          <div class="param-card"><span class="param-label">Ubicaci√≥n Y</span><div class="param-value" id="yValue">0</div></div>
          <div class="param-card"><span class="param-label">Distancia</span><div class="param-value" id="zValue">0</div></div>
          <div class="param-card"><span class="param-label">Giro Yaw</span><div class="param-value" id="yawValue">0</div></div>
          <div class="param-card"><span class="param-label">Inclinaci√≥n Pitch</span><div class="param-value" id="pitchValue">0</div></div>
          <div class="param-card"><span class="param-label">Rotaci√≥n Roll</span><div class="param-value" id="rollValue">0</div></div>
          <div class="param-card"><span class="param-label">Boca</span><div class="param-value" id="mouthValue">0</div></div>
          <div class="param-card"><span class="param-label">Ojo Izquierdo</span><div class="param-value" id="leftEyeValue">0</div></div>
          <div class="param-card"><span class="param-label">Ojo Derecho</span><div class="param-value" id="rightEyeValue">0</div></div>
          <div class="param-card"><span class="param-label">Sonrisa</span><div class="param-value" id="smileValue">0</div></div>
          <div class="param-card"><span class="param-label">Visible</span><div class="param-value" id="faceVisible">0</div></div>
          <div class="param-card"><span class="param-label">Estado</span><div class="param-value" id="faceStatus">No</div></div>
        </div>
      </div>
    </div>
    
    <!-- Instrucciones detalladas -->
    <div class="card-glass" style="max-width: 1000px; margin: 2rem auto 0;">
      <h2 style="color: #00d2ff; text-align: center; margin-bottom: 2rem;">üìö Gu√≠a de Uso - Reconocimiento Facial</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
        <div>
          <h3 style="color: #39ff14; margin-bottom: 1rem;">üéØ ¬øQu√© hace esta app?</h3>
          <ul style="line-height: 1.6; color: #e0e0e0;">
            <li><strong>Detecta caras</strong> en tiempo real usando tu c√°mara</li>
            <li><strong>Calcula 12 par√°metros</strong> faciales diferentes</li>
            <li><strong>Env√≠a datos</strong> a tu micro:bit por Bluetooth</li>
            <li><strong>Procesa a 60fps</strong> para m√°xima fluidez</li>
          </ul>
        </div>
        
        <div>
          <h3 style="color: #39ff14; margin-bottom: 1rem;">üìä Par√°metros que env√≠a</h3>
          <ul style="line-height: 1.6; color: #e0e0e0;">
            <li><strong>Posici√≥n:</strong> X, Y (ubicaci√≥n en pantalla)</li>
            <li><strong>Distancia:</strong> Z (cercan√≠a a la c√°mara)</li>
            <li><strong>Rotaci√≥n:</strong> Yaw, Pitch, Roll</li>
            <li><strong>Expresiones:</strong> Boca, ojos, sonrisa</li>
            <li><strong>Estado:</strong> Visibilidad y detecci√≥n</li>
          </ul>
        </div>
      </div>
      
      <div style="background: rgba(0,210,255,0.1); border-radius: 12px; padding: 1.5rem; border-left: 4px solid #00d2ff; margin-bottom: 2rem;">
        <h3 style="color: #00d2ff; margin-bottom: 1rem;">üí° Ideas de proyectos</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div>
            <strong style="color: #39ff14;">ü§ñ Robot que sigue caras</strong><br>
            Usar X,Y para mover servos y que el robot mire hacia la persona
          </div>
          <div>
            <strong style="color: #39ff14;">üéµ M√∫sica con expresiones</strong><br>
            Tocar diferentes notas seg√∫n la sonrisa o apertura de ojos
          </div>
          <div>
            <strong style="color: #39ff14;">üéÆ Juego de gestos</strong><br>
            Controlar un juego moviendo la cabeza o haciendo muecas
          </div>
          <div>
            <strong style="color: #39ff14;">üìä Monitor de atenci√≥n</strong><br>
            Detectar si el estudiante est√° prestando atenci√≥n en clase
          </div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
          <h3 style="color: #39ff14; margin-bottom: 1rem;">üîß C√≥mo usar</h3>
          <ol style="line-height: 1.8; color: #e0e0e0;">
            <li><strong>Permitir c√°mara</strong> cuando el navegador lo pida</li>
            <li><strong>Conectar micro:bit</strong> con el bot√≥n azul</li>
            <li><strong>Iniciar detecci√≥n</strong> con el bot√≥n play</li>
            <li><strong>Mostrar tu cara</strong> a la c√°mara</li>
            <li><strong>Ver los par√°metros</strong> actualiz√°ndose en tiempo real</li>
          </ol>
        </div>
        
        <div>
          <h3 style="color: #39ff14; margin-bottom: 1rem;">‚ö° Consejos</h3>
          <ul style="line-height: 1.8; color: #e0e0e0;">
            <li><strong>Buena iluminaci√≥n</strong> mejora la detecci√≥n</li>
            <li><strong>Fondo despejado</strong> evita falsas detecciones</li>
            <li><strong>Distancia 50-100cm</strong> de la c√°mara es ideal</li>
            <li><strong>Movimientos suaves</strong> para mejor tracking</li>
          </ul>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(0,210,255,0.2);">
        <p style="color: #b0b0b0; font-size: 0.9rem;">
          <strong>¬øProblemas?</strong> Asegurate de usar Chrome/Edge y tener buena conectividad Bluetooth
        </p>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.1/dist/face-landmarks-detection.min.js"></script>
  <script>
    // Elementos
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const connectBtn = document.getElementById('connectBtn');
    const statusBadge = document.getElementById('statusBadge');
    const sendCount = document.getElementById('sendCount');
    const feedback = document.getElementById('feedback');
    // Par√°metros faciales
    const paramIds = {
      x: 'xValue', y: 'yValue', z: 'zValue', yaw: 'yawValue', pitch: 'pitchValue', roll: 'rollValue',
      mouth: 'mouthValue', leftEye: 'leftEyeValue', rightEye: 'rightEyeValue', smile: 'smileValue',
      visible: 'faceVisible', status: 'faceStatus'
    };
    let faceModel = null;
    let faceStream = null;
    let detecting = false;
    let microbit = { device: null, server: null, service: null, txChar: null, connected: false };
    let params = { x:0, y:0, z:0, yaw:0, pitch:0, roll:0, mouth:0, leftEye:0, rightEye:0, smile:0, visible:0 };
    let sendCounter = 0;
    let cameraMode = 'user';

    // Cargar modelo facial y activar c√°mara autom√°ticamente
    async function loadFaceModelAndCamera() {
      faceModel = await faceLandmarksDetection.load(
        faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
        { maxFaces: 1, refineLandmarks: false }
      );
      startBtn.disabled = false;
      await startDetection();
    }
    loadFaceModelAndCamera();

    // Activar c√°mara y detecci√≥n
    async function startDetection() {
      faceStream = await navigator.mediaDevices.getUserMedia({ video: { width: 480, height: 360, facingMode: cameraMode } });
      video.srcObject = faceStream;
      await video.play();
      // Ajustar tama√±o del canvas al video real
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      // Ajustar mirroring del video seg√∫n c√°mara
      if (cameraMode === 'user') {
        video.style.transform = 'scaleX(-1)';
      } else {
        video.style.transform = 'none';
      }
      detecting = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      detectLoop();
    }
    startBtn.onclick = startDetection;
    stopBtn.onclick = () => {
      detecting = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (faceStream) { faceStream.getTracks().forEach(t => t.stop()); }
      ctx.clearRect(0,0,canvas.width,canvas.height);
    };
    toggleCameraBtn.onclick = () => {
      cameraMode = (cameraMode === 'user') ? 'environment' : 'user';
      if (detecting) {
        stopBtn.onclick();
        startDetection();
      }
    };

    // Detecci√≥n facial y par√°metros
    async function detectLoop() {
      if (!detecting || !faceModel) return;
      const faces = await faceModel.estimateFaces({ input: video, returnTensors: false, flipHorizontal: false });
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      // Mirroring solo si c√°mara frontal
      if (cameraMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      // Ajuste especial para m√≥vil y c√°mara posterior
      if (cameraMode === 'environment' && window.innerWidth < 700) {
        // En m√≥vil, la c√°mara posterior no debe espejarse, pero algunos dispositivos lo hacen por defecto.
        // Para corregir el desfase, NO aplicar mirroring extra aqu√≠.
        // Si el video se ve invertido, ajustar solo el video.style.transform, no el canvas.
      }
      if (faces.length > 0) {
        const face = faces[0];
        const landmarks = face.scaledMesh || face.keypoints;
        // Dibujar puntos
        ctx.fillStyle = '#00ff00';
        landmarks.forEach(p => { ctx.beginPath(); ctx.arc(p[0], p[1], 2, 0, 2*Math.PI); ctx.fill(); });
        // Calcular par√°metros
        const xs = landmarks.map(p => p[0]);
        const ys = landmarks.map(p => p[1]);
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const centerX = (minX + maxX)/2, centerY = (minY + maxY)/2;
        const width = maxX - minX, height = maxY - minY;
        params.x = Math.round((centerX / video.videoWidth) * 99);
        params.y = Math.round((centerY / video.videoHeight) * 99);
        params.z = Math.round((width * height) / (video.videoWidth * video.videoHeight) * 99);
        // Rotaci√≥n
        const noseTip = landmarks[1] || landmarks[0];
        params.yaw = Math.round(50 + (noseTip[0] - centerX) / width * 50);
        params.pitch = Math.round(50 + (noseTip[1] - centerY) / height * 50);
        params.roll = 5;
        // Boca
        const upperLip = landmarks[13], lowerLip = landmarks[14];
        if (upperLip && lowerLip) {
          const mouthOpen = Math.abs(lowerLip[1] - upperLip[1]);
          params.mouth = Math.min(99, Math.round(mouthOpen / 2));
        }
        // Ojos
        const leftEyeTop = landmarks[159], leftEyeBottom = landmarks[145];
        const rightEyeTop = landmarks[386], rightEyeBottom = landmarks[374];
        if (leftEyeTop && leftEyeBottom && rightEyeTop && rightEyeBottom) {
          params.leftEye = Math.min(99, Math.round(Math.abs(leftEyeBottom[1] - leftEyeTop[1]) / 2));
          params.rightEye = Math.min(99, Math.round(Math.abs(rightEyeBottom[1] - rightEyeTop[1]) / 2));
        }
        // Sonrisa
        const leftMouth = landmarks[61], rightMouth = landmarks[291];
        if (leftMouth && rightMouth) {
          const smileWidth = Math.abs(rightMouth[0] - leftMouth[0]);
          params.smile = Math.min(9, Math.round(smileWidth / 20));
        }
        params.visible = 1;
        params.status = 'S√≠';
        // Mostrar par√°metros
        Object.entries(paramIds).forEach(([k,id]) => {
          if (document.getElementById(id)) document.getElementById(id).textContent = params[k] || 0;
        });
        // Enviar a micro:bit si est√° conectado
        if (microbit.connected && microbit.txChar) sendToMicrobit();
      } else {
        params.visible = 0;
        params.status = 'No';
        Object.entries(paramIds).forEach(([k,id]) => {
          if (document.getElementById(id)) document.getElementById(id).textContent = params[k] || 0;
        });
      }
      ctx.restore();
      setTimeout(detectLoop, 200);
    }

    // Conexi√≥n/desconexi√≥n micro:bit
    connectBtn.onclick = async () => {
      if (!microbit.connected) {
        statusBadge.textContent = 'Conectando...';
        connectBtn.disabled = true;
        try {
          microbit.device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: "BBC micro:bit" }],
            optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
          });
          microbit.server = await microbit.device.gatt.connect();
          microbit.service = await microbit.server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
          microbit.txChar = await microbit.service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
          microbit.connected = true;
          statusBadge.textContent = 'Conectado';
          connectBtn.textContent = 'üîå Desconectar';
          connectBtn.disabled = false;
        } catch (e) {
          statusBadge.textContent = 'Error';
          connectBtn.disabled = false;
          alert('Error al conectar: ' + e.message);
        }
      } else {
        if (microbit.server) microbit.server.disconnect();
        microbit.connected = false;
        statusBadge.textContent = 'Desconectado';
        connectBtn.textContent = 'üîó Conectar al Micro:bit';
      }
    };

    // Enviar datos a micro:bit
    function sendToMicrobit() {
      try {
        const cmd =
          pad(params.x) + pad(params.y) + pad(params.z) + pad(params.yaw) + pad(params.pitch) + pad(params.mouth) +
          pad(params.leftEye) + pad(params.rightEye) + Math.floor(params.roll/10) + params.smile + params.visible + '\n';
        const encoder = new TextEncoder();
        microbit.txChar.writeValue(encoder.encode(cmd));
        sendCounter++;
        sendCount.textContent = sendCounter;
        addFeedback(cmd.trim());
      } catch (e) {
        addFeedback('Error');
      }
    }
    function pad(n) { return String(Math.floor(n)).padStart(2,'0'); }
    function addFeedback(cmd) {
      const el = document.createElement('div');
      el.textContent = cmd;
      el.className = 'feedback-item';
      feedback.appendChild(el);
      while (feedback.children.length > 3) feedback.removeChild(feedback.firstChild);
    }
    
    // PWA Installation
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      const installSection = document.getElementById('installSection');
      if (installSection) {
        installSection.style.display = 'block';
      }
    });
    
    function handleInstallApp() {
      const installBtn = document.getElementById('installBtn');
      if (installBtn && deferredPrompt) {
        installBtn.addEventListener('click', async () => {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            console.log('App instalada');
            document.getElementById('installSection').style.display = 'none';
          }
          
          deferredPrompt = null;
        });
      }
    }
    
    window.addEventListener('load', handleInstallApp);
    
  </script>
  
  <!-- Secci√≥n de instalaci√≥n PWA -->
  <div id="installSection" style="display: none; text-align: center; margin: 2rem auto; max-width: 500px;">
    <div class="card-glass" style="padding: 2rem; background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); box-shadow: 0 0 20px rgba(57, 255, 20, 0.1);">
      <h4 style="margin-bottom: 1rem; color: #39ff14; font-size: 1.2rem;">üì± ¬°Instala Face Detection!</h4>
      <p style="font-size: 0.9rem; margin-bottom: 1.5rem; color: #e6f3ff; line-height: 1.5;">Agrega esta app a tu pantalla de inicio para detecci√≥n facial instant√°nea</p>
      <button id="installBtn" class="btn-neon" style="font-size: 1rem; padding: 0.8rem 2rem; background: linear-gradient(45deg, #39ff14, #00d2ff); color: #000; font-weight: bold;">
        üì≤ Instalar App
      </button>
    </div>
  </div>
  
</body>
</html>
