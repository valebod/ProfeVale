<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teachable Machine Profe Vale</title>
  <meta name="description" content="Teachable Machine + micro:bit para IA personalizada - Profe Vale">
  <meta name="theme-color" content="#39ff14">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <style>
    .webcam-container {
      position: relative;
      max-width: 480px;
      margin: 0 auto;
    }
    
    #webcam {
      width: 100%;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 0 24px #00d2ff;
    }
    
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      pointer-events: none;
    }
    
    .model-input {
      background: rgba(44,62,80,0.8);
      border: 2px solid #39ff14;
      border-radius: 8px;
      padding: 0.7rem;
      color: #e0e0e0;
      font-size: 1rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    .model-input:focus {
      outline: none;
      box-shadow: 0 0 12px #39ff14;
    }
    
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .status-disconnected {
      background: rgba(255,46,99,0.2);
      border: 2px solid #ff2e63;
      color: #ff2e63;
    }
    
    .status-connected {
      background: rgba(57,255,20,0.2);
      border: 2px solid #39ff14;
      color: #39ff14;
    }
    
    .prediction-display {
      background: rgba(0,210,255,0.1);
      border: 2px solid #00d2ff;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .prediction-class {
      font-size: 1.5rem;
      font-weight: bold;
      color: #00d2ff;
      text-shadow: 0 0 8px #00d2ff;
    }
    
    .prediction-confidence {
      font-size: 1rem;
      color: #e0e0e0;
      margin-top: 0.5rem;
    }
    
    .help-text {
      font-size: 0.9rem;
      color: #b0b0b0;
      line-height: 1.4;
      margin-bottom: 1rem;
    }
    
    @media (max-width: 700px) {
      .container { padding: 1rem 0.5rem; }
      .card-glass { padding: 0.8rem; }
      .model-input { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="header-glow">ü§ñ Teachable Machine + micro:bit</h1>
    
    <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center;">
      <!-- Panel de configuraci√≥n -->
      <div style="flex: 1; min-width: 320px; max-width: 500px;">
        <div class="card-glass">
          <h2>üìù Configuraci√≥n del Modelo</h2>
          <p class="help-text">
            Peg√° ac√° el link de tu modelo de Teachable Machine. Debe ser el link que termina con tu ID de proyecto.
          </p>
          <input 
            type="url" 
            id="modelUrl" 
            class="model-input"
            placeholder="https://storage.googleapis.com/tm-model/tu-proyecto-id/"
            value="">
          <button id="loadModelBtn" class="btn-neon" style="width: 100%;">üîÑ Cargar Modelo</button>
          <div id="modelStatus" class="status-badge status-disconnected">Modelo no cargado</div>
        </div>
        
        <div class="card-glass">
          <h2>üì° Conexi√≥n micro:bit</h2>
          <p class="help-text">
            Conect√° tu micro:bit por Bluetooth. Asegurate de que tenga el c√≥digo que recibe datos por UART.
          </p>
          <button id="connectBtn" class="btn-neon" style="width: 100%; margin-bottom: 0.5rem;">üîó Conectar micro:bit</button>
          <button id="disconnectBtn" class="btn-neon" style="width: 100%;" disabled>‚ùå Desconectar</button>
          <div id="btStatus" class="status-badge status-disconnected">Desconectado</div>
        </div>
        
        <div class="card-glass">
          <h2>üìä Estad√≠sticas</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
            <div>
              <div style="color: #39ff14; font-weight: bold;">Predicciones</div>
              <div id="predictionCount" style="font-size: 1.5rem;">0</div>
            </div>
            <div>
              <div style="color: #00d2ff; font-weight: bold;">Enviados</div>
              <div id="sentCount" style="font-size: 1.5rem;">0</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Panel de c√°mara y predicciones -->
      <div style="flex: 1; min-width: 320px; max-width: 500px;">
        <div class="card-glass">
          <h2>üìπ C√°mara y Predicciones</h2>
          <div class="webcam-container">
            <video id="webcam" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
          </div>
          <button id="toggleCameraBtn" class="btn-neon" style="width: 100%; margin-top: 1rem;">üîÑ Cambiar C√°mara</button>
        </div>
        
        <div class="card-glass">
          <h2>üéØ Predicci√≥n Actual</h2>
          <div class="prediction-display">
            <div id="prediction" class="prediction-class">Sin predicci√≥n</div>
            <div id="confidence" class="prediction-confidence">Carg√° un modelo y conect√° la c√°mara</div>
          </div>
          <div style="font-size: 0.9rem; color: #b0b0b0;">
            <strong>√öltima clase enviada:</strong> <span id="lastSent">Ninguna</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card-glass" style="max-width: 1000px; margin: 2rem auto 0;">
      <h2>‚ÑπÔ∏è Instrucciones</h2>
      <ol style="line-height: 1.6;">
        <li><strong>Entren√° tu modelo:</strong> And√° a <a href="https://teachablemachine.withgoogle.com/" target="_blank" style="color: #39ff14;">teachablemachine.withgoogle.com</a> y cre√° un modelo de imagen.</li>
        <li><strong>Export√° el modelo:</strong> Cuando termines de entrenar, clicke√° "Export Model" y copi√° el link.</li>
        <li><strong>Peg√° el link:</strong> Peg√° el link en el campo de arriba y clicke√° "Cargar Modelo".</li>
        <li><strong>Conect√° la micro:bit:</strong> Asegurate de que tu micro:bit tenga c√≥digo para recibir datos por Bluetooth.</li>
        <li><strong>¬°Experiment√°!:</strong> Mostr√° objetos/gestos a la c√°mara y mir√° c√≥mo se env√≠an las predicciones a la micro:bit.</li>
      </ol>
    </div>
    
    <div class="card-glass" style="max-width: 1000px; margin: 2rem auto 0;">
      <h2>üíª C√≥digo MakeCode</h2>
      <div style="background: #1a1a1a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #0077ff;">
        <h4 style="color: #0077ff; margin-bottom: 0.8rem;">üì± Programa tu micro:bit:</h4>
        <p style="color: #e0e0e0; font-size: 0.85rem; margin-bottom: 1rem;">Copia este c√≥digo en MakeCode (makecode.microbit.org):</p>
        <textarea readonly style="width: 100%; height: 130px; background: #000; color: #0f0; border: 1px solid #333; border-radius: 4px; padding: 0.5rem; font-family: monospace; font-size: 0.75rem; resize: vertical;">bluetooth.startUartService()
basic.showString("TM")

bluetooth.onUartDataReceived(serial.delimiters(Delimiters.NewLine), function () {
    let clase = bluetooth.uartReadUntil(serial.delimiters(Delimiters.NewLine))
    
    if (clase == "Clase1") {
        basic.showIcon(IconNames.Heart)
        pins.digitalWritePin(DigitalPin.P0, 1)
        music.playTone(262, music.beat(BeatFraction.Half))
    } else if (clase == "Clase2") {
        basic.showIcon(IconNames.Diamond)
        pins.digitalWritePin(DigitalPin.P1, 1)
        music.playTone(392, music.beat(BeatFraction.Half))
    } else if (clase == "Clase3") {
        basic.showIcon(IconNames.Square)
        pins.digitalWritePin(DigitalPin.P2, 1)
        music.playTone(523, music.beat(BeatFraction.Half))
    }
    
    basic.pause(1000)
    basic.clearScreen()
    pins.digitalWritePin(DigitalPin.P0, 0)
    pins.digitalWritePin(DigitalPin.P1, 0)
    pins.digitalWritePin(DigitalPin.P2, 0)
})</textarea>
        <div style="text-align: center; margin: 1rem 0;">
          <button onclick="navigator.clipboard.writeText(this.parentNode.previousElementSibling.value); this.textContent='‚úÖ ¬°Copiado!'; setTimeout(()=>this.textContent='üìã Copiar C√≥digo', 2000)" class="btn-neon" style="font-size: 0.8rem;">
            üìã Copiar C√≥digo
          </button>
        </div>
        <ul style="color: #e0e0e0; line-height: 1.4; font-size: 0.8rem;">
          <li><strong>Recibe clases</strong> del modelo Teachable Machine</li>
          <li><strong>Acciones personalizadas</strong> seg√∫n cada predicci√≥n</li>
          <li><strong>LEDs y sonidos</strong> para cada categor√≠a</li>
          <li><strong>Control de servos</strong> basado en las clases</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  
  <script>
    // Variables globales
    let model = null;
    let webcam = null;
    let ctx = null;
    let overlay = null;
    let maxPredictions = 0;
    let isLooping = false;
    let cameraFacing = 'environment'; // 'user' para frontal, 'environment' para trasera
    
    // Bluetooth variables
    let btDevice = null;
    let btServer = null;
    let uartService = null;
    let txChar = null;
    let isBtConnected = false;
    
    // Contadores
    let predictionCounter = 0;
    let sentCounter = 0;
    let lastSentClass = '';
    
    // Elementos del DOM
    const modelUrlInput = document.getElementById('modelUrl');
    const loadModelBtn = document.getElementById('loadModelBtn');
    const modelStatus = document.getElementById('modelStatus');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const btStatus = document.getElementById('btStatus');
    const webcamElement = document.getElementById('webcam');
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const predictionElement = document.getElementById('prediction');
    const confidenceElement = document.getElementById('confidence');
    const lastSentElement = document.getElementById('lastSent');
    const predictionCountElement = document.getElementById('predictionCount');
    const sentCountElement = document.getElementById('sentCount');
    
    // Inicializaci√≥n
    overlay = document.getElementById('overlay');
    ctx = overlay.getContext('2d');
    
    // Cargar modelo de Teachable Machine
    loadModelBtn.onclick = async () => {
      const url = modelUrlInput.value.trim();
      
      if (!url) {
        updateModelStatus('Ingres√° un URL v√°lido', 'disconnected');
        return;
      }
      
      // Validar URL b√°sico
      if (!url.includes('teachablemachine') && !url.includes('storage.googleapis.com')) {
        updateModelStatus('URL debe ser de Teachable Machine', 'disconnected');
        return;
      }
      
      updateModelStatus('Cargando modelo...', 'disconnected');
      loadModelBtn.disabled = true;
      
      try {
        // Asegurar que termine con /
        const modelURL = url.endsWith('/') ? url : url + '/';
        
        model = await tmImage.load(modelURL + 'model.json', modelURL + 'metadata.json');
        maxPredictions = model.getTotalClasses();
        
        updateModelStatus(`Modelo cargado (${maxPredictions} clases)`, 'connected');
        await startWebcam();
        
      } catch (error) {
        console.error('Error cargando modelo:', error);
        updateModelStatus('Error: Verific√° el URL del modelo', 'disconnected');
      } finally {
        loadModelBtn.disabled = false;
      }
    };
    
    // Iniciar webcam
    async function startWebcam() {
      try {
        // Detener webcam anterior si existe
        if (webcam) {
          webcam.stop();
        }
        
        const constraints = {
          video: { 
            facingMode: cameraFacing,
            width: { ideal: 480 },
            height: { ideal: 360 }
          }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        webcamElement.srcObject = stream;
        
        webcamElement.onloadedmetadata = () => {
          overlay.width = webcamElement.videoWidth;
          overlay.height = webcamElement.videoHeight;
          
          if (!isLooping && model) {
            isLooping = true;
            predictionLoop();
          }
        };
        
      } catch (error) {
        console.error('Error accediendo a la c√°mara:', error);
        updatePrediction('Error de c√°mara', 'Verific√° permisos');
      }
    }
    
    // Cambiar c√°mara
    toggleCameraBtn.onclick = async () => {
      cameraFacing = cameraFacing === 'user' ? 'environment' : 'user';
      if (model) {
        await startWebcam();
      }
    };
    
    // Loop de predicciones
    async function predictionLoop() {
      if (!model || !webcamElement.videoWidth) {
        isLooping = false;
        return;
      }
      
      try {
        // Hacer predicci√≥n
        const prediction = await model.predict(webcamElement);
        
        // Encontrar la clase con mayor confianza
        let bestPrediction = prediction[0];
        for (let i = 1; i < prediction.length; i++) {
          if (prediction[i].probability > bestPrediction.probability) {
            bestPrediction = prediction[i];
          }
        }
        
        predictionCounter++;
        predictionCountElement.textContent = predictionCounter;
        
        // Actualizar UI
        const confidence = (bestPrediction.probability * 100).toFixed(1);
        updatePrediction(bestPrediction.className, `${confidence}%`);
        
        // Enviar a micro:bit si la confianza es alta y es diferente a la anterior
        if (isBtConnected && bestPrediction.probability > 0.75 && bestPrediction.className !== lastSentClass) {
          await sendToMicrobit(bestPrediction.className);
          lastSentClass = bestPrediction.className;
          sentCounter++;
          sentCountElement.textContent = sentCounter;
          lastSentElement.textContent = bestPrediction.className;
        }
        
        // Dibujar overlay
        drawOverlay(bestPrediction, confidence);
        
      } catch (error) {
        console.error('Error en predicci√≥n:', error);
      }
      
      if (isLooping) {
        requestAnimationFrame(predictionLoop);
      }
    }
    
    // Dibujar overlay en canvas
    function drawOverlay(prediction, confidence) {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      
      // Configurar estilo
      ctx.font = '24px Montserrat';
      ctx.fillStyle = 'rgba(57,255,20,0.9)';
      ctx.strokeStyle = '#232946';
      ctx.lineWidth = 2;
      
      // Texto de predicci√≥n
      const text = `${prediction.className}: ${confidence}%`;
      const metrics = ctx.measureText(text);
      const x = 10;
      const y = 35;
      
      // Fondo del texto
      ctx.fillStyle = 'rgba(35,41,70,0.8)';
      ctx.fillRect(x - 5, y - 25, metrics.width + 10, 35);
      
      // Texto
      ctx.fillStyle = '#39ff14';
      ctx.fillText(text, x, y);
    }
    
    // Conexi√≥n Bluetooth
    connectBtn.onclick = async () => {
      updateBtStatus('Buscando micro:bit...', 'disconnected');
      
      try {
        btDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'BBC micro:bit' }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });
        
        btDevice.addEventListener('gattserverdisconnected', onBtDisconnected);
        
        btServer = await btDevice.gatt.connect();
        uartService = await btServer.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        txChar = await uartService.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
        
        isBtConnected = true;
        updateBtStatus('¬°micro:bit conectado!', 'connected');
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        
      } catch (error) {
        console.error('Error conectando Bluetooth:', error);
        updateBtStatus('Error de conexi√≥n', 'disconnected');
      }
    };
    
    // Desconectar Bluetooth
    disconnectBtn.onclick = async () => {
      if (btDevice && btDevice.gatt.connected) {
        await btDevice.gatt.disconnect();
      }
      onBtDisconnected();
    };
    
    // Manejar desconexi√≥n
    function onBtDisconnected() {
      isBtConnected = false;
      updateBtStatus('Desconectado', 'disconnected');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      lastSentClass = '';
    }
    
    // Enviar datos a micro:bit
    async function sendToMicrobit(className) {
      if (!txChar) return;
      
      try {
        const encoder = new TextEncoder();
        await txChar.writeValue(encoder.encode(className + '\\n'));
      } catch (error) {
        console.error('Error enviando a micro:bit:', error);
        updateBtStatus('Error enviando datos', 'disconnected');
      }
    }
    
    // Funciones de actualizaci√≥n de UI
    function updateModelStatus(text, status) {
      modelStatus.textContent = text;
      modelStatus.className = `status-badge status-${status}`;
    }
    
    function updateBtStatus(text, status) {
      btStatus.textContent = text;
      btStatus.className = `status-badge status-${status}`;
    }
    
    function updatePrediction(className, confidence) {
      predictionElement.textContent = className;
      confidenceElement.textContent = confidence;
    }
    
    // Ejemplo de URL para ayudar al usuario
    modelUrlInput.placeholder = "https://storage.googleapis.com/tm-model/tu-proyecto-id/";
    
    // PWA Installation
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      const installSection = document.getElementById('installSection');
      if (installSection) {
        installSection.style.display = 'block';
      }
    });
    
    function handleInstallApp() {
      const installBtn = document.getElementById('installBtn');
      if (installBtn && deferredPrompt) {
        installBtn.addEventListener('click', async () => {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            console.log('App instalada');
            document.getElementById('installSection').style.display = 'none';
          }
          
          deferredPrompt = null;
        });
      }
    }
    
    window.addEventListener('load', handleInstallApp);
    
  </script>
  
  <!-- Secci√≥n de instalaci√≥n PWA -->
  <div id="installSection" style="display: none; text-align: center; margin: 2rem auto; max-width: 500px;">
    <div class="card-glass" style="padding: 2rem;">
      <h4 style="margin-bottom: 1rem; font-size: 1.2rem;">üì± ¬°Instala la App!</h4>
      <p style="font-size: 0.9rem; margin-bottom: 1.5rem; line-height: 1.5;">Instala la app para controlar tu microbit con teachable machine</p>
      <button id="installBtn" class="btn-neon" style="font-size: 1rem; padding: 0.8rem 2rem; background: linear-gradient(45deg, #39ff14, #00d2ff); color: #000; font-weight: bold;">
        üì≤ Instalar App
      </button>
    </div>
  </div>
  
</body>
</html>